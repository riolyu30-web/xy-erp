# ERP系统接口文档

## 1. 健康检查接口 (health.py)

### 1.1 服务健康检查

**接口地址：** `GET /health`

**功能描述：** 检查服务运行状态和数据库连接情况

**请求参数：** 无

**响应示例：**
```json
"Service is running"
```

**可能响应：**
- `"Service is running"` - 服务正常运行且数据库连接成功
- `"Supabase connection failed"` - 数据库连接失败
- `"Service error: {错误信息}"` - 服务异常

### 1.2 聊天健康检查

**接口地址：** `POST /chat/health`

**功能描述：** 测试聊天功能是否正常工作

**请求头：**
- `Authorization: Bearer {token}` (必需)

**请求体：**
```json
{
  "question": "测试问题"
}
```

**响应：** 流式返回AI响应文本

## 2. 用户认证接口 (auth.py)

### 2.1 用户注册

**接口地址：** `POST /auth/signup`

**功能描述：** 创建新用户账户

**请求体：**
```json
{
  "username": "用户名",
  "password": "密码"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "注册成功"
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "注册失败，请检查用户名是否已存在"
}
```

### 2.2 用户登录

**接口地址：** `POST /auth/signin`

**功能描述：** 用户身份验证并获取访问令牌

**请求体：**
```json
{
  "username": "用户名",
  "password": "密码"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "登录成功",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "登录失败，用户名或密码错误"
}
```

### 2.3 用户注销

**接口地址：** `POST /auth/signout`

**功能描述：** 注销当前用户会话

**请求体：**
```json
{
  "token": "用户令牌"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "注销成功"
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "注销失败"
}
```

### 2.4 获取用户信息

**接口地址：** `GET /auth/user/{token}`

**功能描述：** 验证令牌有效性并获取用户信息

**路径参数：**
- `token` - 用户访问令牌

**响应示例：**
```json
{
  "success": true,
  "message": "Token 有效",
  "user": {
    "id": "用户ID",
    "username": "用户名",
    "其他用户信息": "..."
  }
}
```

**失败响应：**
```json
{
  "success": false,
  "message": "Token 无效或已过期"
}
```

## 3. 意图识别接口 (intent.py)

### 3.1 聊天意图识别

**接口地址：** `POST /chat/intent`

**功能描述：** 识别用户输入的意图并提取相关参数

**请求头：**
- `Authorization: Bearer {token}` (必需)

**请求体：**
```json
{
  "question": "用户输入的问题",
  "memory": "记忆数据(JSON字符串，可选)"
}
```

**响应示例：**
```json
{
  "intent": "订单",
  "question": "用户原始问题",
  "answer": {
    "name": "get_order_data",
    "arguments": {
      "开始时间": "2025-01-01 00:00:00",
      "结束时间": "2025-01-31 23:59:59"
    }
  },
  "hint": "请确认您要查询2025年1月1日至2025年1月31日的订单数据？",
  "flag": "[comfirm]"
}
```

**支持的意图类型：**
1. **订单** - 查询订单相关信息
   - 关键词：["订单", "查询", "查看", "状态", "详情"]
   - 必需参数：开始时间、结束时间

2. **起名** - 根据用户信息起名
   - 关键词：["起名", "取名", "名字", "命名", "叫什么", "姓名"]
   - 必需参数：姓氏、性别、出生日期、出生时间、出生城市、字数要求

**标志(flag)说明：**
- `[callback]` - 需要补充参数
- `[doubt]` - 意图不确定，需要确认
- `[comfirm]` - 参数已完整，需要确认执行
- `[function]` - 确认执行功能
- `[stream]` - 直接进入聊天流
- `[reject]` - 拒绝请求

## 4. 聊天接口 (chat.py)

### 4.1 MCP聊天

**接口地址：** `POST /chat/mcp`

**功能描述：** 基于MCP(Model Context Protocol)的智能聊天接口

**请求头：**
- `Authorization: Bearer {token}` (必需)

**请求体：**
```json
{
  "question": "用户问题"
}
```

**响应：** 流式返回AI响应文本

**MCP服务器配置：**
- 默认连接地址：`http://localhost:9050/sse`
- 生产环境地址：`https://mcp.riohome.top/sse`

## 5. 通用说明

### 5.1 认证机制

除健康检查接口外，所有接口均需要在请求头中包含有效的访问令牌：
```
Authorization: Bearer {token}
```

### 5.2 错误处理

所有接口在发生错误时会返回相应的错误信息，格式为：
```json
{
  "success": false,
  "message": "错误描述"
}
```

### 5.3 数据格式

- 所有请求和响应数据均采用JSON格式
- 日期时间格式：`YYYY-MM-DD HH:MM:SS`
- 字符串编码：UTF-8

### 5.4 环境信息

- 测试环境地址：`http://localhost:8001`
- 正式环境地址：`https://erp.riohome.top`
- 完整API文档：`https://erp.riohome.top/docs`