### 部署步骤

#### 1、打包上传到git

```bash
# 初始化git仓库（如果还没有）
git init

# 确认.gitignore文件存在（会自动忽略venv等目录）
cat .gitignore

# 查看将要添加的文件（验证不包含venv等）
git status

# 添加所有文件到暂存区
git add .

# 再次确认暂存的文件（可选）
git status

# 提交变更
git commit -m "feat: add fastapi stream service"

# 将分支重命名为main（如果当前是master分支）
git branch -M main

# 添加远程仓库地址（替换为你的仓库地址）
git remote add origin https://github.com/riolyu30-web/xy-erp.git

# 推送到远程仓库
git push -u origin main
```

**📌 重要说明：**
- `.gitignore` 文件会自动忽略 `venv/`、`__pycache__/`、`*.log` 等文件
- `git status` 可以查看哪些文件会被提交，确保不包含虚拟环境
- 只会上传源代码、配置文件和文档，不会上传依赖库

#### 2、云端下载

```bash
# SSH连接到云服务器
ssh root@your-server-ip

# 克隆代码仓库
git clone https://github.com/riolyu30-web/xy-erp.git

# 进入项目目录
cd tx-erp/erp-service
```

#### 3、创建环境

```bash
# 安装Python3（如果未安装，以Ubuntu为例）
sudo apt update
sudo apt install python3 python3-pip python3-venv -y

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装依赖包
pip install fastapi uvicorn dashscope pydantic

# 或者创建requirements.txt后安装
pip install -r requirements.txt
```

**requirements.txt内容：**
```txt
fastapi==0.109.0
uvicorn==0.27.0
dashscope==1.14.0
pydantic==2.5.3
```

#### 4、运行

**方式一：前台运行（测试用）**
```bash
# 激活虚拟环境
source venv/bin/activate

# 直接运行
python main.py
```

**方式二：后台运行（推荐）**
```bash
# 使用nohup后台运行
nohup python main.py > service.log 2>&1 &

# 查看运行日志
tail -f service.log

# 查看进程
ps aux | grep main.py

# 停止服务
kill -9 $(ps aux | grep 'main.py' | grep -v grep | awk '{print $2}')
```

**方式三：使用systemd服务（生产环境推荐）**
```bash
# 创建服务文件
sudo nano /etc/systemd/system/xy-erp.service
```

**服务文件内容：**
```ini
[Unit]
Description=ERP AI Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/xy-erp
Environment="PATH=/var/www/xy-erp/.venv/bin"
ExecStart=/var/www/xy-erp/.venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启动服务：**
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start xy-erp

# 设置开机自启
sudo systemctl enable xy-erp

# 查看服务状态
sudo systemctl status xy-erp

# 查看日志
sudo journalctl -u erp-service -f
```

#### 5、反向代理

**使用Nginx进行反向代理：**

```bash
# 安装Nginx（如果未安装）
sudo apt install nginx -y

# 创建配置文件
sudo nano /etc/nginx/sites-available/erp-service
```

**Nginx配置内容：**
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或服务器IP

    # 允许大文件上传
    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8001;  # 代理到FastAPI服务
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 流式响应配置
        proxy_buffering off;  # 关闭缓冲，支持流式输出
        proxy_read_timeout 300s;  # 设置读取超时时间
    }
}
```

**启用配置并重启Nginx：**
```bash
# 创建软链接启用配置
sudo ln -s /etc/nginx/sites-available/xy-erp /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

**配置HTTPS（可选，使用Let's Encrypt）：**
```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run


(xy-erp) root@iZ7xv3he6rt004yblpr6u2Z:/var/www/xy-erp# sudo certbot --nginx -d erp.riohome.top
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for erp.riohome.top

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/erp.riohome.top/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/erp.riohome.top/privkey.pem
This certificate expires on 2026-02-11.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

Deploying certificate
Successfully deployed certificate for erp.riohome.top to /etc/nginx/sites-enabled/xy-erp
Congratulations! You have successfully enabled HTTPS on https://erp.riohome.top

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(xy-erp) root@iZ7xv3he6rt004yblpr6u2Z:/var/www/xy-erp# sudo certbot renew --dry-run
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Processing /etc/letsencrypt/renewal/api.riohome.top.conf
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Account registered.
Simulating renewal of an existing certificate for api.riohome.top

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Processing /etc/letsencrypt/renewal/erp.riohome.top.conf
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Simulating renewal of an existing certificate for erp.riohome.top

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations, all simulated renewals succeeded: 
  /etc/letsencrypt/live/api.riohome.top/fullchain.pem (success)
  /etc/letsencrypt/live/erp.riohome.top/fullchain.pem (success)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
```

#### 6、创建测试网页

**创建测试HTML页面：**

```bash
# 创建测试文件
nano /root/tx-erp/erp-service/test.html
```


**使用Nginx托管测试页面：**
```bash
# 将测试页面复制到Nginx目录
sudo cp test.html /var/www/html/

# 访问地址
# http://your-domain.com/test.html
```

**使用Python简易服务器测试（本地）：**
```bash
# 在test.html所在目录运行
python -m http.server 8080

# 浏览器访问
# http://localhost:8080/test.html
```

### 常用维护命令

```bash
# 查看服务状态
sudo systemctl status erp-service

# 重启服务
sudo systemctl restart erp-service

# 停止服务
sudo systemctl stop erp-service

# 查看实时日志
sudo journalctl -u erp-service -f

# 查看最近100行日志
sudo journalctl -u erp-service -n 100

# 更新代码
cd /root/tx-erp/erp-service
git pull
sudo systemctl restart erp-service

# 查看端口占用
netstat -tulnp | grep 8001

# 防火墙开放端口（如需要）
sudo ufw allow 8001
sudo ufw allow 80
sudo ufw allow 443
```

#### 本地代码有变更后处理方案

**本地操作（开发机器）：**

```bash
# 进入项目目录
cd E:\tx-erp\erp-service

# 查看修改的文件
git status

# 查看具体修改内容
git diff

# 添加修改的文件到暂存区
git add .
# 或者只添加特定文件
git add main.py docs/服务部署.md

# 提交修改（写清楚修改内容）
git commit -m "fix: 修复流式响应超时问题"
# 或
git commit -m "feat: 添加新的API接口"
# 或
git commit -m "docs: 更新部署文档"

# 推送到远程仓库
git push origin main
```

**云端操作（服务器）：**

```bash
# SSH连接到服务器
ssh root@your-server-ip

# 进入项目目录
cd /root/tx-erp/erp-service

# 拉取最新代码
git pull origin main

# 如果使用虚拟环境，激活它
source venv/bin/activate

# 如果有新的依赖包，更新安装
pip install -r requirements.txt

# 重启服务
sudo systemctl restart erp-service

# 查看服务状态
sudo systemctl status erp-service

# 查看最新日志（确认服务正常）
sudo journalctl -u erp-service -n 50 -f
```

**常见Git提交规范：**

```bash
# 新功能
git commit -m "feat: 添加用户认证功能"

# 修复bug
git commit -m "fix: 修复登录失败问题"

# 文档更新
git commit -m "docs: 更新API文档"

# 代码重构
git commit -m "refactor: 重构数据库连接逻辑"

# 性能优化
git commit -m "perf: 优化查询性能"

# 样式修改
git commit -m "style: 格式化代码"

# 测试相关
git commit -m "test: 添加单元测试"

# 依赖更新
git commit -m "chore: 更新依赖包版本"
```

**快速更新脚本（可选）：**

在服务器上创建更新脚本：

```bash
# 创建更新脚本
nano /root/tx-erp/erp-service/update.sh
```

**update.sh 内容：**

```bash
#!/bin/bash

echo "========================================="
echo "开始更新 ERP Service"
echo "========================================="

# 进入项目目录
cd /root/tx-erp/erp-service

# 拉取最新代码
echo ">>> 拉取最新代码..."
git pull origin main

# 检查是否有 requirements.txt 更新
if git diff HEAD@{1} HEAD --name-only | grep -q "requirements.txt"; then
    echo ">>> 检测到依赖更新，重新安装依赖..."
    source venv/bin/activate
    pip install -r requirements.txt
fi

# 重启服务
echo ">>> 重启服务..."
sudo systemctl restart erp-service

# 等待服务启动
sleep 3

# 检查服务状态
echo ">>> 检查服务状态..."
sudo systemctl status erp-service --no-pager

# 显示最新日志
echo ">>> 最新日志："
sudo journalctl -u erp-service -n 20 --no-pager

echo "========================================="
echo "更新完成！"
echo "========================================="
```

**赋予执行权限并使用：**

```bash
# 赋予执行权限
chmod +x /root/tx-erp/erp-service/update.sh

# 执行更新
/root/tx-erp/erp-service/update.sh
```

**处理冲突（如果本地和远程都有修改）：**

```bash
# 如果拉取时提示冲突
git pull origin main

# 查看冲突文件
git status

# 编辑冲突文件，解决冲突标记
nano conflicted_file.py

# 解决冲突后标记为已解决
git add conflicted_file.py

# 完成合并
git commit -m "merge: 解决代码冲突"

# 推送合并结果（如果在本地）
git push origin main
```

**回滚到之前版本（紧急情况）：**

```bash
# 查看提交历史
git log --oneline -10

# 回滚到指定版本（保留修改）
git reset --soft <commit-id>

# 回滚到指定版本（丢弃修改，慎用！）
git reset --hard <commit-id>

# 重启服务
sudo systemctl restart erp-service

# 如果需要强制推送（慎用！）
git push -f origin main
```

**最佳实践：**

1. **开发流程**：
   - 本地开发 → 测试 → 提交 → 推送 → 服务器拉取 → 重启

2. **提交前检查**：
   - 确保代码没有语法错误
   - 本地测试通过
   - 提交信息清晰明确

3. **更新频率**：
   - 小改动及时提交
   - 重大更新做好备份
   - 生产环境更新前先在测试环境验证

4. **安全建议**：
   - 不要提交敏感信息（API密钥、密码等）
   - 使用环境变量管理配置
   - 定期备份数据库

5. **监控日志**：
   - 更新后及时查看日志
   - 发现问题立即回滚
   - 记录每次更新的影响